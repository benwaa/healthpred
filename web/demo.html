<!DOCTYPE html>

<head>
    <title>Health Prediciton</title>
    <link rel="stylesheet" href="data/style.css" type="text/css" media="screen" />
    <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
</head>
<meta charset="utf-8">

<body>
    <div id="main-wrapper">
        <div id="controls">
            <div class="sentence">I am&nbsp;</div>
            <div id="sex" class="dropdown-wrapper" , tabindex="1" style="float:left;z-index:10">
                <span>Sex</span>
                <ul class="dropdown"></ul>
            </div>
            <div id="race" class="dropdown-wrapper" , tabindex="2" style="float:left;z-index:9">
                <span>Race</span>
                <ul class="dropdown"></ul>
            </div>
            <div class="sentence">Zip Code:</div>
            <div class="sentence">
                <input type="text" name="zip">
            </div>
            <div class="sentence">and currently</div>
            <div id="age">
                <div id="agevalue"></div>
                <div id="ageslider" class="sliderholder"></div>
            </div>
            <div class="sentence">years old.</div>
            <div id="speed">
                <div id="pausebutton" class="togglebutton">Play</div>
                <div class="clr"></div>
            </div>
            <div class="clr"></div>
        </div>
        <div id="controls">
            <div class="sentence">Going to hospital for:</div>
            <div id="procedure" class="dropdown-wrapper" , tabindex="3" style="float:left;z-index:8">
                <span>Procedure</span>
                <ul class="dropdown"></ul>
            </div>
        </div>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <div id="controls">
            <div id="counts">
                <div id="currentage">
                    <div class="subtitle">Age of Surgery</div>
                    <div class="valholder"><span class="prefix"></span><span class="val"></span> years</div>
                </div>
                <div class="clr"></div>
                <div class="subtitle">Hospital Costs</div>
                <div id="barvals"></div>
                <div id="barchart"></div>
            </div>
        </div>
    </div>
</body>
<!-- @end #main-wrapper -->
<script src="data/d3.min.js"></script>
<script src="data/d3.slider.js"></script>
<script>
var data_loc = "data/test.tsv";


var total_lives = 783,
    surgery_so_far = 0,
    maxp = 1,
    reset = false,
    life_radius = 8,
    padding = 1,
    default_fill = "#ccc";

var paused = true;

var facilities = {
    "Beth_Israel_Medical_CenterPetrie_Campus": {
        "name": "Beth Israel-Petrie",
        "descrip": "Beth Israel Medical Center Petrie Campus",
        color: "#74be34",
        count: 0
    },
    "NYU_Hospital_for_Joint_Diseases": {
        "name": "NYU-Joint Disease",
        "descrip": "NYU Hospital for Joint Diseases",
        color: "#ca4471",
        count: 0
    },
    "Hospital_for_Special_Surgery": {
        "name": "HSS",
        "descrip": "Hospital_for_Special_Surgery",
        color: "#ffb7c7",
        count: 0
    },
    "Lenox_Hill_Hospital": {
        "name": "Lenox Hill",
        "descrip": "Lenox_Hill_Hospital",
        color: "#fdac51",
        count: 0
    },
    "Memorial_Hospital_for_Cancer_and_Allied_Diseases": {
        "name": "Memorial Hospital",
        "descrip": "Memorial Hospital for Cancer and Allied Diseases",
        color: "#948ec2",
        count: 0
    },
    "Mount_Sinai_Hospital": {
        "name": "Mt Sinai",
        "descrip": "Mount Sinai Hospital",
        color: "#f366da",
        count: 0
    },
    "New_York_Presbyterian_Hospital__New_York_Weill_Cornell_Center": {
        "name": "NYP-Cornell",
        "descrip": "New York Presbyterian Hospital New York Weill Cornell Center",
        color: "#8c53d3",
        count: 0
    },
    "NYU_Hospitals_Center": {
        "name": "NYU-Hospital Center",
        "descrip": "NYU Hospitals Center",
        color: "#5574f0",
        count: 0
    },
    "New_York_Presbyterian_Hospital__Columbia_Presbyterian_Center": {
        "name": "NYP-Columbia",
        "descrip": "New York Presbyterian Hospital Columbia Presbyterian Center",
        color: "#ac8f4d",
        count: 0
    },
    "Mount_Sinai_Beth_Israel": {
        "name": "Mt Sinai Beth Israel",
        "descrip": "Mount Sinai Beth Israel",
        color: "#df5d75",
    }
}



var sexes = {
    "F": "female",
    "M": "male",
};

var races = {
    "asian": "Asian",
    "black": "Black",
    "native": "Native",
    "white": "White",
};

var css_procedures = {
    "HIP_REPLACEMENT_TOT_PRT": "Total Hip Replacement",
    "SPINAL_FUSION": "Spinal Fusion",
    "ALCO_DRUG_REHAB_DETOX": "Drug or Alcohol Rehab & Detox",
    "ARTHROPLASTY_KNEE": "Knee Replacement",
    "PHYS_THER_EXER__MANIPUL": "Out-Patient Physical Therapy Visit",
};

var USER_AGE = 35; // = getRandomItem([0, 4, 14, 24, 34, 49, 64, 74], [1, 7, 7, 7, 7, 7, 5, 3]);
var USER_SEX; // = getRandomItem(d3.keys(sexes), [1, 1]);
var USER_RACE; // = getRandomItem(d3.keys(races), [5, 13, 1, 72]);
var USER_PROCEDURE;
var USER_SPEED = 200;
var CURR_AGE; // = USER_AGE;



var margin = {
        top: 0,
        right: 5,
        bottom: 5,
        left: 10
    },
    width = 540 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var ncol = Math.floor(width / (2 * (life_radius + padding)));
// var ncol = 50;



// scales and axes
var x = d3.scale.linear()
    .range([0, 340])
    .domain([0, 1]); // hard-coding this because I know the data


// Start the bar chart
var count = d3.select("#barchart")
    .selectAll("div")
    .data(d3.keys(facilities))
    .enter().append("div")
    .attr("id", function(d) {
        return d;
    })
    .attr("class", "count");

count.append("div")
    .attr("class", "bar")
    .style("width", function(d) {
        return 10 * facilities[d]['count'] + "px";
    })
    .style("background", function(d) {
        return facilities[d]['color'];
    });

count.append("div")
    .attr("class", "countlabel")
    .text(function(d) {
        return facilities[d]['name'];
    });

// Bar chart tickers
var cause_ticker = d3.select("#barvals")
    .selectAll("div")
    .data(d3.keys(facilities))
    .enter().append("div")
    .attr("id", function(d) {
        return d + "val";
    })
    .attr("class", "val")
    .text("$0");


var age_probs = {};
d3.tsv(data_loc, type, function(error, data) {

    // Sex dropdown menu
    var dropdown_sex = d3.select("#controls #sex");
    dropdown_sex.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_sex_li = dropdown_sex.select(".dropdown").selectAll("li")
        .data(d3.keys(sexes))
        .enter().append("li")
        .attr("id", function(d) {
            return d;
        })
        .classed("current", function(d) {
            return d == USER_SEX ? true : false;
        })
        .text(function(d) {
            return sexes[d];
        });
    dropdown_sex_li.on("click", function(d) {
        d3.select("#sex span").text(sexes[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#sex #" + USER_SEX).classed("current", false); // Show previously hidden

        USER_SEX = d;
        resetCounts();
        update();
    });

    // Procedure dropdown menu
    var dropdown_procedure = d3.select("#controls #procedure");
    dropdown_procedure.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_procedure_li = dropdown_procedure.select(".dropdown").selectAll("li")
        .data(d3.keys(css_procedures))
        .enter().append("li")
        .attr("id", function(d) {
            return d;
        })
        .classed("current", function(d) {
            return d == USER_PROCEDURE ? true : false;
        })
        .text(function(d) {
            return css_procedures[d];
        });
    dropdown_procedure_li.on("click", function(d) {
        d3.select("#procedure span").text(css_procedures[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#procedure #" + USER_PROCEDURE).classed("current", false); // Show previously hidden

        USER_PROCEDURE = d;
        resetCounts();
        update();
    });


    // Race dropdown menu
    var dropdown_race = d3.select("#controls #race");
    // dropdown_race.select("span").text(races[USER_RACE]);
    dropdown_race.on("click", function() {
        d3.select(this).classed("active", !d3.select(this).classed("active"));
    });
    var dropdown_race_li = dropdown_race.select(".dropdown").selectAll("li")
        .data(d3.keys(races))
        .enter().append("li")
        .attr("id", function(d) {
            return d;
        })
        .classed("current", function(d) {
            return d == USER_RACE ? true : false;
        })
        .text(function(d) {
            return races[d];
        });
    dropdown_race_li.on("click", function(d) {
        d3.select("#race span").text(races[d]);
        d3.select(this).classed("current", true); // Hide currently selected metric from menu
        d3.select("#race #" + USER_RACE).classed("current", false); // Show previously hidden

        USER_RACE = d;
        resetCounts();
        update();
    });

    // Age slider
    var age_slider = d3.slider().min(0).max(100).ticks(0).stepValues(d3.range(0, 100)).value(USER_AGE)
        .callback(brushed);
    d3.select("#ageslider").call(age_slider);
    d3.select("#agevalue").text(USER_AGE);

    // Pause button
    d3.select("#pausebutton").on("click", function() {
        if (paused == true) {
            paused = !paused;
            d3.select(this).text("Pause");
            setTimeout(timer, USER_SPEED);
        } else {
            paused = !paused;
            d3.select(this).text("Live");
        }
    });


    d3.keys(races).forEach(function(d) {
        var age_ranges = ["_0_to_17", "_18_to_29", "_30_to_49", "_50_to_69", "_70_or_Older"];
        age_probs[d] = age_ranges.map(function(i) {
            var arr = {}
            arr[i] = {
                "M": {
                    'facility': [],
                    'cost': []
                },
                "F": {
                    'facility': [],
                    'cost': [] // 'causes': [], // 'datas': [], // 'probs': []

                }
            };
            return arr;
        });
        age_probs[d] = toObject(age_probs[d]);
    });

    data.forEach(function(d, i) {
        age_probs['white'][d["Age.Group"]]['F']['facility'].push(d["Facility.Name"]);
        age_probs['white'][d["Age.Group"]]['F']['cost'].push(d["Total.Charges"]);
    });


    // var death_count = 0;
    function toObject(arr) {
        var rv = {};
        for (var i = 0; i < arr.length; ++i) {
            prop_name = Object.keys(arr[i])[0];
            rv[prop_name] = arr[i][prop_name];
        }
        return rv;
    }

    function timer() {

        if (!paused) {
            update();
            CURR_AGE += 1;

            // Reset
            if (CURR_AGE > 100) {
                resetCounts();
                setTimeout(timer, USER_SPEED * 10);

            } else {
                setTimeout(timer, USER_SPEED);

            }

        } // @end if !paused

    }
    setTimeout(timer, USER_SPEED);

    // Reset values and counters.
    function resetCounts() {

        reset = true;
        surgery_so_far = 0;
        maxp = 1;

        d3.keys(facilities).forEach(function(d) {
            facilities[d]['count'] = 0;
        });

        CURR_AGE = USER_AGE;

    }

    function update() {
        d3.select("#currentage .val").text(CURR_AGE);
        if (CURR_AGE == 80) {
            d3.select("#currentage .prefix").text("+");
        } else {
            d3.select("#currentage .prefix").text("");
        }

        if (reset) {
            // Reset bar charts to zero.
            x.domain([0, maxp]);
            d3.selectAll("#counts div.bar")
                .transition()
                .duration(USER_SPEED + 10)
                .ease("linear")
                .style("width", function(d) {
                    return x(0) + "px";
                });

            // Reset bar tickers.
            d3.selectAll("#counts #barvals .val").text("0%");

            reset = false;
        } else {

            updatePct();

            // Update bar charts.
            x.domain([0, maxp]);
            d3.selectAll("#counts div.bar")
                .transition()
                .duration(USER_SPEED + 10)
                .ease("linear")
                .style("width", function(d) {
                    return x(facilities[d]['count'] / surgery_so_far) + "px";
                });

            // Update bar tickers.
            d3.selectAll("#counts #barvals .val")
                .text(function(d) {
                    if (surgery_so_far == 0) {
                        return "0%";
                    } else {
                        return Math.round(100 * facilities[d]['count'] / surgery_so_far) + "%";
                    }
                });
        }
    } // @end update()


    function updateOLD() {

        // Update age ticker.
        d3.select("#currentage .val").text(CURR_AGE);
        if (CURR_AGE == 100) {
            d3.select("#currentage .prefix").text("+");
        } else {
            d3.select("#currentage .prefix").text("");
        }


        if (reset) {

            // Make circles come back.
            svg.selectAll(".lifeholder")
                .style("stroke", default_fill)
            svg.selectAll(".lifecircle")
                .style("fill", default_fill)
                .transition()
                .duration(USER_SPEED - 20)
                .ease("cubic")
                .attr("r", life_radius);

            // Reset bar charts to zero.
            x.domain([0, maxp]);
            d3.selectAll("#counts div.bar")
                .transition()
                .duration(USER_SPEED + 10)
                .ease("linear")
                .style("width", function(d) {
                    return x(0) + "px";
                });

            // Reset bar tickers.
            d3.selectAll("#counts #barvals .val").text("0%");

            reset = false;
        } else {

            updatePct();

            // Update circles.
            var marked = svg.selectAll(".life.marked");

            marked
                .select(".lifeholder")
                .transition()
                .duration(USER_SPEED - 20)
                .style("stroke", function(d) {
                    return facilities[d.cause]["color"];
                })
                .style("fill", function(d) {
                    return facilities[d.cause]["color"];
                });

            marked
                .classed("marked", false)
                .select(".lifecircle")
                .transition()
                .duration(USER_SPEED - 20)
                .ease("cubic", "in")
                .style("fill", function(d) {
                    return facilities[d.cause]["color"];
                })
                .attr("r", 0);

            // Update bar charts.
            x.domain([0, maxp]);
            d3.selectAll("#counts div.bar")
                .transition()
                .duration(USER_SPEED + 10)
                .ease("linear")
                .style("width", function(d) {
                    return x(facilities[d]['count'] / surgery_so_far) + "px";
                });

            // Update bar tickers.
            d3.selectAll("#counts #barvals .val")
                .text(function(d) {
                    if (surgery_so_far == 0) {
                        return "0%";
                    } else {
                        return Math.round(100 * facilities[d]['count'] / surgery_so_far) + "%";
                    }
                });
        }


    } // @end updateOLD()


    function updatePct() {
        if (d3.select("#currentage .val").text() == '100') {
            d3.select("#currentpctdead .val").text(100);
            d3.select("#currentpctalive .val").text(0);
        } else {
            var new_val = Math.round(100 * surgery_so_far / total_lives);
            d3.select("#currentpctdead .val").text(new_val);

            var new_val_alive = 100 - new_val;
            d3.select("#currentpctalive .val").text(new_val_alive);
        }

    }

    function brushed() {
        USER_AGE = age_slider.value();
        d3.select("#agevalue").text(USER_AGE);

        resetCounts();
        update();
    }

}); // @end d3.csv()




function simOneYear(age, sex, race, age_probs) {
    p = Math.random() * 100000;

    if (age == 100) {
        p_death = 1 * 100000;
    } else if (age >= 85) {
        p_death = age; //age_probs[race][age][sex]["probs"][0];
    } else {
        p_death = age; //d3.sum(age_probs[race][age][sex]["probs"]);
    }

    // Died.
    if (p <= p_death) {
        if (age >= 85) {
            var cause = getRandomItem(age_probs[race][age][sex]["causes"], age_probs[race][age][sex]["deaths"]);
        } else {
            var cause = getRandomItem(age_probs[race][age][sex]["causes"], age_probs[race][age][sex]["probs"]);
        }
        return cause;
    } else {
        return false;
    }
}


function type(d) {
    d.age = +d.age;
    d.deaths = +d.deaths;
    d.rate100k = +d.rate100k;
    return d;
}

function rand(min, max) {
    return Math.random() * (max - min) + min;
}

function getRandomItem(list, weight) {
    // var total_weight = weight.reduce(function (prev, cur, i, arr) {
    //     return prev + cur;
    // });
    var total_weight = d3.sum(weight);

    var random_num = rand(0, total_weight);
    var weight_sum = 0;


    for (var i = 0; i < list.length; i++) {
        weight_sum += weight[i];
        weight_sum = +weight_sum.toFixed(2);

        if (random_num <= weight_sum) {
            return list[i];
        }
    }

    // end of function
}
</script>
