<!DOCTYPE html>

<head>
    <title>Health Prediciton</title>
    <link rel="stylesheet" href="data/style.css" type="text/css" media="screen" />
    <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
</head>
<script>
var url = (window.location != window.parent.location) ? document.referrer : document.location.href;
</script>
<meta charset="utf-8">

<body>
    <div id="main-wrapper">
        <div id="controls">
            <div class="sentence">I am&nbsp;</div>
            <div id="sex" class="dropdown-wrapper" , tabindex="1" style="float:left;z-index:10">
                <span>Sex</span>
                <ul class="dropdown"></ul>
            </div>
            <div id="race" class="dropdown-wrapper" , tabindex="2" style="float:left;z-index:9">
                <span>Race</span>
                <ul class="dropdown"></ul>
            </div>
            <div class="sentence">Zip Code:</div>
            <div class="sentence">
                <input type="text" name="zip	">
            </div>
            <div class="sentence">and currently</div>
            <div id="age">
                <div id="agevalue"></div>
                <div id="ageslider" class="sliderholder"></div>
            </div>
            <div class="sentence">years old.</div>
            <div id="speed">
                <div id="pausebutton" class="togglebutton">Pause</div>
                <div class="clr"></div>
            </div>
            <div class="clr"></div>
        </div>
        <div id="controls">
            <div class="sentence">Going to hospital for:</div>
            <div id="procedure" class="dropdown-wrapper" , tabindex="3" style="float:left;z-index:8">
                <span>Procedure</span>
                <ul class="dropdown"></ul>
            </div>
        </div>
        <div id="lives">&nbsp;</div>
        <div id="counts">
            <div id="currentage">
                <div class="subtitle">Age of Surgery</div>
                <div class="valholder"><span class="prefix"></span><span class="val"></span> years</div>
            </div>
        </div>
        <div id="controls">
        <br>
        <br>
        <br>
        <br>
            <div class="subtitle">Hospital Costs</div>
        </div>
        <div id="barvals"></div>
        <div id="barchart"></div>
    </div>
</body>
<!-- @end #main-wrapper -->
<script src="data/d3.min.js"></script>
<script src="data/d3.slider.js"></script>
<script>
var sexes = {
    "F": "female",
    "M": "male",
};

var races = {
    "Other_Race": "Other",
    "Black_African_American": "Black",
    "White": "White",
};

var css_procedures = {
    "HIP_REPLACEMENT_TOT_PRT": "Total Hip Replacement",
    "SPINAL_FUSION": "Spinal Fusion",
    "ALCO_DRUG_REHAB_DETOX": "Drug or Alcohol Rehab & Detox",
    "ARTHROPLASTY_KNEE": "Knee Replacement",
    "PHYS_THER_EXER__MANIPUL": "Out-Patient Physical Therapy Visit",
};


var USER_AGE = getRandomItem([0, 4, 14, 24, 34, 49, 64, 74], [1, 7, 7, 7, 7, 7, 5, 3]);
var USER_SEX;
var USER_RACE;
var USER_PROCEDURE;
var USER_SPEED;
var CURR_AGE;

// Sex dropdown menu
var dropdown_sex = d3.select("#controls #sex");
//dropdown_sex.select("span").text(sexes[USER_SEX]);
dropdown_sex.on("click", function() {
    d3.select(this).classed("active", !d3.select(this).classed("active"));
});
var dropdown_sex_li = dropdown_sex.select(".dropdown").selectAll("li")
    .data(d3.keys(sexes))
    .enter().append("li")
    .attr("id", function(d) {
        return d;
    })
    .classed("current", function(d) {
        return d == USER_SEX ? true : false;
    })
    .text(function(d) {
        return sexes[d];
    });
dropdown_sex_li.on("click", function(d) {
    d3.select("#sex span").text(sexes[d]);
    d3.select(this).classed("current", true); // Hide currently selected metric from menu
    d3.select("#sex #" + USER_SEX).classed("current", false); // Show previously hidden

    USER_SEX = d;
    resetCounts();
    update();
});

// Age slider
var age_slider = d3.slider().min(0).max(100).ticks(0).stepValues(d3.range(0, 100)).value(USER_AGE)
    .callback(brushed);
d3.select("#ageslider").call(age_slider);
d3.select("#agevalue").text(USER_AGE);

// Race dropdown menu
var dropdown_race = d3.select("#controls #race");
//dropdown_race.select("span").text(races[USER_RACE]);
dropdown_race.on("click", function() {
    d3.select(this).classed("active", !d3.select(this).classed("active"));
});
var dropdown_race_li = dropdown_race.select(".dropdown").selectAll("li")
    .data(d3.keys(races))
    .enter().append("li")
    .attr("id", function(d) {
        return d;
    })
    .classed("current", function(d) {
        return d == USER_RACE ? true : false;
    })
    .text(function(d) {
        return races[d];
    });
dropdown_race_li.on("click", function(d) {
    d3.select("#race span").text(races[d]);
    d3.select(this).classed("current", true); // Hide currently selected metric from menu
    d3.select("#race #" + USER_RACE).classed("current", false); // Show previously hidden

    USER_RACE = d;
    resetCounts();
    update();
});

// Procedure dropdown menu
var dropdown_procedure = d3.select("#controls #procedure");
//dropdown_procedure.select("span").text(races[USER_PROCEDURE]);
dropdown_procedure.on("click", function() {
    d3.select(this).classed("active", !d3.select(this).classed("active"));
});
var dropdown_procedure_li = dropdown_procedure.select(".dropdown").selectAll("li")
    .data(d3.keys(css_procedures))
    .enter().append("li")
    .attr("id", function(d) {
        return d;
    })
    .classed("current", function(d) {
        return d == USER_PROCEDURE ? true : false;
    })
    .text(function(d) {
        return css_procedures[d];
    });
dropdown_procedure_li.on("click", function(d) {
    d3.select("#procedure span").text(css_procedures[d]);
    d3.select(this).classed("current", true); // Hide currently selected metric from menu
    d3.select("#procedure #" + USER_PROCEDURE).classed("current", false); // Show previously hidden

    USER_PROCEDURE = d;
    resetCounts();
    update();
});

// Pause button
d3.select("#pausebutton").on("click", function() {
    if (paused == true) {
        paused = !paused;
        d3.select(this).text("Pause");
        setTimeout(timer, USER_SPEED);
    } else {
        paused = !paused;
        d3.select(this).text("Live");
    }
});

function brushed() {
    USER_AGE = age_slider.value();
    d3.select("#agevalue").text(USER_AGE);

    resetCounts();
    update();
}

function update() {} // @end update()

// Reset values and counters.
function resetCounts() {} // @end resetCounts()


function rand(min, max) {
    return Math.random() * (max - min) + min;
}

function getRandomItem(list, weight) {
    // var total_weight = weight.reduce(function (prev, cur, i, arr) {
    //     return prev + cur;
    // });
    var total_weight = d3.sum(weight);

    var random_num = rand(0, total_weight);
    var weight_sum = 0;


    for (var i = 0; i < list.length; i++) {
        weight_sum += weight[i];
        weight_sum = +weight_sum.toFixed(2);

        if (random_num <= weight_sum) {
            return list[i];
        }
    }
} // @end getRandomItem()
</script>
